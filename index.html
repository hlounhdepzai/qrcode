<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Scan ‚Äî auto m·ªü link + ting</title>
  <style>
    :root{
      --bg: #0f1115; --card:#151823; --text:#e8ecf1; --muted:#93a0b4; --brand:#6ee7b7; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(120deg,#0b0f14,#10131a 40%,#0b0f14); color:var(--text); min-height:100svh; display:grid; place-items:center;}
    .wrap{width:min(960px,92vw);}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin:18px 0 10px}
    header h1{font-size:clamp(18px,3.6vw,28px); margin:0; letter-spacing:.3px}
    .card{background:var(--card); border:1px solid #23283a; border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .videoWrap{position:relative; border-radius:16px; overflow:hidden; aspect-ratio:3/4; background:#0a0d14}
    video{width:100%; height:100%; object-fit:cover; background:#000}
    canvas{position:absolute; inset:0; width:100%; height:100%;}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:12px}
    .btn{appearance:none; border:1px solid #2a3047; background:#1b2030; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn.primary{background:var(--brand); color:#04110a; border-color:#58cda0}
    .btn.danger{background:#2a1220; border-color:#522034; color:#ffd6e0}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .switch{display:inline-flex; align-items:center; gap:8px; font-size:14px; color:var(--muted)}
    .switch input{width:40px; height:22px; appearance:none; border-radius:999px; background:#2a3047; position:relative; outline:none; cursor:pointer}
    .switch input:checked{background:#1e4438}
    .switch input::after{content:""; position:absolute; inset:3px auto 3px 3px; width:16px; border-radius:50%; background:#cfd6e6; transition:.2s}
    .switch input:checked::after{left:21px; background:#baf7de}

    .side{display:flex; flex-direction:column; gap:12px}
    .hint{color:var(--muted); font-size:14px}
    .list{max-height:340px; overflow:auto; border:1px dashed #2b3147; border-radius:12px; padding:10px}
    .item{padding:10px; border-radius:10px; background:#101522; border:1px solid #1e2436; margin:8px 0}
    .item small{color:var(--muted)}
    .url{display:block; color:#9ad8ff; text-decoration:none; word-break:break-all; margin-top:6px}
    .nonurl{color:#ffd28f}
    .status{font-size:14px; color:var(--muted); margin-left:6px}
    footer{opacity:.75; font-size:12px; text-align:center; margin:16px 0 24px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üì∑ Qu√©t QR ‚Äî t·ª± m·ªü link + ting</h1>
      <div class="status" id="status">Ch∆∞a kh·ªüi ƒë·ªông camera</div>
    </header>

    <div class="card grid">
      <section>
        <div class="videoWrap">
          <video id="video" playsinline muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary">B·∫≠t qu√©t</button>
          <button id="stopBtn" class="btn danger" disabled>T·∫Øt</button>
          <label class="switch" title="T·ª± m·ªü link n·∫øu n·ªôi dung l√† URL">
            <input id="autoOpen" type="checkbox" checked>
            <span>T·ª± m·ªü link</span>
          </label>
          <label class="switch" title="B·∫≠t √¢m thanh th√¥ng b√°o">
            <input id="soundOn" type="checkbox" checked>
            <span>B·∫≠t ti·∫øng ting</span>
          </label>
        </div>
        <p class="hint">Tip: ƒë∆∞a m√£ v√†o khung h√¨nh, gi·ªØ tay v·ªØng 1‚Äì2 gi√¢y. N·∫øu kh√¥ng ch·∫°y, th·ª≠ d√πng Chrome m·ªõi nh·∫•t & cho ph√©p quy·ªÅn camera.</p>
      </section>

      <aside class="side">
        <div>
          <strong>K·∫øt qu·∫£ g·∫ßn ƒë√¢y</strong>
          <div class="list" id="list"></div>
        </div>
        <div class="hint">B·∫£o m·∫≠t: T·∫•t c·∫£ x·ª≠ l√Ω tr√™n tr√¨nh duy·ªát, kh√¥ng g·ª≠i d·ªØ li·ªáu ƒëi ƒë√¢u c·∫£.</div>
      </aside>
    </div>

    <footer>Made for speed ‚Ä¢ Native <code>BarcodeDetector</code> ‚Ä¢ No backend</footer>
  </div>

  <script>
    // --- Utilities
    const qs = (s)=>document.querySelector(s);
    const statusEl = qs('#status');
    const video = qs('#video');
    const overlay = qs('#overlay');
    const ctx = overlay.getContext('2d');
    const listEl = qs('#list');
    const startBtn = qs('#startBtn');
    const stopBtn = qs('#stopBtn');
    const autoOpenEl = qs('#autoOpen');
    const soundOnEl = qs('#soundOn');

    let stream = null;
    let scanning = false;
    let rafId = 0;
    let detector = null;
    let lastText = '';
    let lastDingAt = 0;

    const hasBarcode = 'BarcodeDetector' in window;

    function setStatus(t){ statusEl.textContent = t; }

    function isProbablyURL(text){
      try{ const u = new URL(text); return !!u.protocol.startsWith('http'); }catch{ return /^https?:\/\//i.test(text) || /\w+\.[a-z]{2,}/i.test(text); }
    }

    function addItem(text){
      const div = document.createElement('div');
      div.className = 'item';
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<small>${time}</small><br/>` +
        (isProbablyURL(text) ? `<a class="url" href="${text.startsWith('http')?text:'https://'+text}" target="_blank" rel="noopener">${text}</a>`
                              : `<span class="nonurl">${text}</span>`);
      listEl.prepend(div);
    }

    // --- Sound (WebAudio tiny "ting")
    let audioCtx;
    function ding(){
      if(!soundOnEl.checked) return;
      const now = performance.now();
      if(now - lastDingAt < 1200) return; // prevent spam
      lastDingAt = now;
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      o.connect(g).connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + 0.28);
    }

    // --- Camera + Scan
    async function start(){
      try{
        if(!hasBarcode){
          alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ BarcodeDetector. Vui l√≤ng d√πng Chrome/Edge/Android m·ªõi.');
          return;
        }
        detector = new BarcodeDetector({ formats: ['qr_code'] });
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        video.srcObject = stream;
        await video.play();
        resizeCanvas();
        scanning = true;
        startBtn.disabled = true; stopBtn.disabled = false;
        setStatus('ƒêang qu√©t...');
        scanLoop();
      }catch(err){
        console.error(err);
        setStatus('Kh√¥ng m·ªü ƒë∆∞·ª£c camera. H√£y ki·ªÉm tra quy·ªÅn truy c·∫≠p.');
      }
    }
    function stop(){
      scanning = false;
      cancelAnimationFrame(rafId);
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      ctx.clearRect(0,0,overlay.width,overlay.height);
      startBtn.disabled = false; stopBtn.disabled = true;
      setStatus('ƒê√£ t·∫Øt camera');
    }
    function resizeCanvas(){
      const rect = video.getBoundingClientRect();
      overlay.width = rect.width * devicePixelRatio;
      overlay.height = rect.height * devicePixelRatio;
      overlay.style.width = rect.width + 'px';
      overlay.style.height = rect.height + 'px';
      ctx.lineWidth = 4 * devicePixelRatio; ctx.strokeStyle = '#6ee7b7'; ctx.fillStyle = 'rgba(110,231,183,.12)';
    }
    window.addEventListener('resize', ()=>{ if(video.videoWidth) resizeCanvas(); });

    async function scanLoop(){
      if(!scanning) return;
      try{
        const barcodes = await detector.detect(video);
        ctx.clearRect(0,0,overlay.width,overlay.height);
        if(barcodes.length){
          for(const code of barcodes){
            drawBox(code.boundingBox);
            const text = code.rawValue?.trim();
            if(text && text !== lastText){
              lastText = text;
              addItem(text);
              ding();
              if(autoOpenEl.checked && isProbablyURL(text)){
                const href = text.startsWith('http') ? text : 'https://' + text;
                // Try open in new tab (user gesture from camera start may allow)
                window.open(href, '_blank', 'noopener');
              }
            }
          }
        }
      }catch(e){
        console.debug('detect error', e);
      }
      rafId = requestAnimationFrame(scanLoop);
    }

    function drawBox(box){
      // box: {x,y,width,height} in CSS pixels of video element
      const scaleX = overlay.width / overlay.clientWidth;
      const scaleY = overlay.height / overlay.clientHeight;
      const x = box.x * scaleX, y = box.y * scaleY, w = box.width * scaleX, h = box.height * scaleY;
      ctx.strokeRect(x,y,w,h);
      ctx.fillRect(x,y,w,h);
    }

    // --- Bindings
    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    // Quality-of-life: auto-stop when tab hidden
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); });
  </script>
</body>
</html>
